<pou name="AnalogValve" pouType="functionBlock">
    <interface>
        <inOutVars>
            <variable name="MTPBase"><type><derived name="FB_MTP_MonAnaVlv" /></type></variable>
        </inOutVars>
        <inputVars>
            <variable name="targetPosition"><type><REAL /></type></variable>
            <variable name="feedbackPosition"><type><WORD /></type></variable>
            <variable name="scaleMin"><type><REAL /></type></variable>
            <variable name="scaleMax"><type><REAL /></type></variable>
            <variable name="feedbackOpen"><type><BOOL /></type></variable>
            <variable name="feedbackClose"><type><BOOL /></type></variable>
            <variable name="hasFbOpen"><type><BOOL /></type></variable>
            <variable name="hasFbClose"><type><BOOL /></type></variable>
            <variable name="safeOpen"><type><BOOL /></type></variable>
            <variable name="safeHold"><type><BOOL /></type></variable>
            <variable name="simulate"><type><BOOL /></type></variable>
            <variable name="simulateDelay"><type><REAL /></type></variable>
            <variable name="interlockIn"><type><BOOL /></type></variable>
            <variable name="permitIn"><type><BOOL /></type></variable>
            <variable name="protectIn"><type><BOOL /></type></variable>
            <variable name="reset"><type><BOOL /></type></variable>
        </inputVars>
        <outputVars>
            <variable name="positionOutDevice"><type><WORD /></type></variable>
            <variable name="positionOut"><type><REAL /></type></variable>
            <variable name="remote"><type><BOOL /></type></variable>
            <variable name="operator"><type><BOOL /></type></variable>
            <variable name="automatic"><type><BOOL /></type></variable>
            <variable name="offline"><type><BOOL /></type></variable>
            <variable name="error"><type><BOOL /></type></variable>
            <variable name="opened"><type><BOOL /></type></variable>
            <variable name="closed"><type><BOOL /></type></variable>
            <variable name="remoteSource"><type><BOOL /></type></variable>
            <variable name="internalSourceAct"><type><BOOL /></type></variable>
            <variable name="manualSourceAct"><type><BOOL /></type></variable>
        </outputVars>
        <localVars>
            <variable name="fbOpenSimulated"><type><BOOL /></type></variable>
            <variable name="fbCloseSimulated"><type><BOOL /></type></variable>
            <variable name="DelayTimer1"><type><derived name="TON" /></type></variable>
            <variable name="DelayTimer2"><type><derived name="TON" /></type></variable><!-- Temporary variables for MTP base interface access -->
            <variable name="StateChannel"><type><BOOL /></type></variable>
            <variable name="StateOpAct"><type><BOOL /></type></variable>
            <variable name="StateAutAct"><type><BOOL /></type></variable>
            <variable name="StateOffAct"><type><BOOL /></type></variable>
            <variable name="SrcChannel"><type><BOOL /></type></variable>
            <variable name="SrcIntAct"><type><BOOL /></type></variable>
            <variable name="SrcManAct"><type><BOOL /></type></variable>
            <variable name="PermEn"><type><BOOL /></type></variable>
            <variable name="Permit"><type><BOOL /></type></variable>
            <variable name="IntlEn"><type><BOOL /></type></variable>
            <variable name="Interlock"><type><BOOL /></type></variable>
            <variable name="ProtEn"><type><BOOL /></type></variable>
            <variable name="Protect"><type><BOOL /></type></variable>
            <variable name="WQC"><type><BYTE /></type></variable>
            <variable name="OSLevel"><type><BYTE /></type></variable>
            <variable name="SafePos"><type><BOOL /></type></variable>
            <variable name="SafePosEn"><type><BOOL /></type></variable>
            <variable name="OpenAut"><type><BOOL /></type></variable>
            <variable name="CloseAut"><type><BOOL /></type></variable>
            <variable name="PosSclMin"><type><REAL /></type></variable>
            <variable name="PosSclMax"><type><REAL /></type></variable>
            <variable name="PosUnit"><type><INT /></type></variable>
            <variable name="PosMin"><type><REAL /></type></variable>
            <variable name="PosMax"><type><REAL /></type></variable>
            <variable name="PosInt"><type><REAL /></type></variable>
            <variable name="Pos"><type><REAL /></type></variable>
            <variable name="OpenFbkCalc"><type><BOOL /></type></variable>
            <variable name="OpenFbk"><type><BOOL /></type></variable>
            <variable name="CloseFbkCalc"><type><BOOL /></type></variable>
            <variable name="CloseFbk"><type><BOOL /></type></variable>
            <variable name="PosFbkCalc"><type><BOOL /></type></variable>
            <variable name="PosFbk"><type><REAL /></type></variable>
            <variable name="ResetAut"><type><BOOL /></type></variable>
        </localVars>
    </interface>
    <body>
        <ST>
            <xhtml xmlns="http://www.w3.org/1999/xhtml">
                <![CDATA[

// execute the MTP base, and copy everything from/to local variables
MTPBase(
    MTPBase.PermEn := PermEn,
    MTPBase.Permit := Permit,
    MTPBase.IntlEn := IntlEn,
    MTPBase.Interlock := Interlock,
    MTPBase.ProtEn := ProtEn,
    MTPBase.Protect := Protect,
    MTPBase.WQC := WQC,
    MTPBase.OSLevel := OSLevel,
    MTPBase.SafePos := SafePos,
    MTPBase.SafePosEn := SafePosEn,
    MTPBase.OpenAut := OpenAut,
    MTPBase.CloseAut := CloseAut,
    MTPBase.PosSclMin := PosSclMin,
    MTPBase.PosSclMax := PosSclMax,
    MTPBase.PosUnit := PosUnit,
    MTPBase.PosMin := PosMin,
    MTPBase.PosMax := PosMax,
    MTPBase.PosInt := PosInt,
    MTPBase.OpenFbkCalc := OpenFbkCalc,
    MTPBase.OpenFbk := OpenFbk,
    MTPBase.CloseFbkCalc := CloseFbkCalc,
    MTPBase.CloseFbk := CloseFbk,
    MTPBase.PosFbkCalc := PosFbkCalc,
    MTPBase.PosFbk := PosFbk,
    MTPBase.ResetAut := ResetAut,
    StateChannel := MTPBase.StateChannel,
    StateOpAct := MTPBase.StateOpAct,
    StateAutAct := MTPBase.StateAutAct,
    StateOffAct := MTPBase.StateOffAct,
    SrcChannel := MTPBase.SrcChannel,
    SrcIntAct := MTPBase.SrcIntAct,
    SrcManAct := MTPBase.SrcManAct,
    OpenAut := MTPBase.OpenAut,
    PosSclMin := MTPBase.PosSclMin,
    PosSclMax := MTPBase.PosSclMax,
    Pos := MTPBase.Pos,
    OpenFbk := MTPBase.OpenFbk,
    CloseFbk := MTPBase.CloseFbk,
);


// Functionality

WQC := 16#FF;
OSLevel := 16#00;
remote := StateChannel;
operator := StateOpAct;
automatic := StateAutAct;
offline := StateOffAct;
remoteSource := SrcChannel;
internalSourceAct := SrcIntAct;
manualSourceAct := SrcManAct;
PermEn := True;
IntlEn := True;
ProtEn := True;
Permit := permitIn;
Interlock := interlockIn;
IF protectIn THEN
    Protect := TRUE;
END_IF;
SafePos := safeOpen;
SafePosEn := safeHold;
OpenAut := targetPosition > 0;
CloseAut := NOT OpenAut;
OpenFbkCalc := simulate OR NOT feedbackOpen;
CloseFbkCalc := simulate OR NOT feedbackClose;
DelayTimer1(IN:= (simulate OR NOT hasFbOpen) AND OpenAut, PT:= REAL_TO_TIME(simulateDelay * 1000));
fbOpenSimulated := DelayTimer1.Q;
DelayTimer2(IN:= (simulate OR NOT hasFbClose) AND NOT OpenAut, PT:= REAL_TO_TIME(simulateDelay * 1000));
fbCloseSimulated := DelayTimer2.Q;
OpenFbk := feedbackOpen OR fbOpenSimulated;
CloseFbk := feedbackClose OR fbCloseSimulated;
opened := OpenAut AND OpenFbk;
closed := NOT OpenAut AND CloseFbk;
ResetAut := reset;
PosSclMin := scaleMin;
PosSclMax := scaleMax;
PosUnit := 0;
PosMin := PosSclMin;
PosMax := PosSclMax;
PosInt := targetPosition;
PosFbk := feedbackPosition;
positionOut := Pos;
reset := False;

                ]]>
            </xhtml>
        </ST>
    </body>
</pou>