<pou name="AnalogValve" pouType="functionBlock">
    <interface>
        <inOutVars>
            <variable name="MTPBase"><type><derived name="MonAnaVlv" /></type></variable>
        </inOutVars>
        <inputVars>
            <variable name="id"><type><INT /></type></variable>
            <variable name="activateManualSource"><type><BOOL /></type></variable>
            <variable name="activateDynamicSource"><type><BOOL /></type></variable>
            <variable name="activateFixedSource"><type><BOOL /></type></variable>
            <variable name="dynamicSource"><type><REAL /></type></variable>
            <variable name="fixedSource"><type><REAL /></type></variable>
            <variable name="feedbackPosition"><type><WORD /></type></variable>
            <variable name="scaleMin"><type><REAL /></type></variable>
            <variable name="scaleMax"><type><REAL /></type></variable>
            <variable name="feedbackOpen"><type><BOOL /></type></variable>
            <variable name="feedbackClose"><type><BOOL /></type></variable>
            <variable name="hasFbOpen"><type><BOOL /></type></variable>
            <variable name="hasFbClose"><type><BOOL /></type></variable>
            <variable name="safeOpen"><type><BOOL /></type></variable>
            <variable name="enableSafePos"><type><BOOL /></type></variable>
            <variable name="simulate"><type><BOOL /></type></variable>
            <variable name="simulateDelay"><type><REAL /></type></variable>
            <variable name="interlockIn"><type><BOOL /></type></variable>
            <variable name="permitIn"><type><BOOL /></type></variable>
            <variable name="protectIn"><type><BOOL /></type></variable>
            <variable name="reset"><type><BOOL /></type></variable>
        </inputVars>
        <outputVars>
            <variable name="positionOutDevice"><type><WORD /></type></variable>
            <variable name="positionOut"><type><REAL /></type></variable>
            <variable name="remote"><type><BOOL /></type></variable>
            <variable name="operator"><type><BOOL /></type></variable>
            <variable name="automatic"><type><BOOL /></type></variable>
            <variable name="offline"><type><BOOL /></type></variable>
            <variable name="error"><type><BOOL /></type></variable>
            <variable name="opened"><type><BOOL /></type></variable>
            <variable name="closed"><type><BOOL /></type></variable>
            <variable name="programSelectsSource"><type><BOOL /></type></variable>
            <variable name="operatorSelectsSource"><type><BOOL /></type></variable>
            <variable name="manualSourceAct"><type><BOOL /></type></variable>
            <variable name="internalSourceAct"><type><BOOL /></type></variable>
            <variable name="dynamicSourceAct"><type><BOOL /></type></variable>
            <variable name="fixedSourceAct"><type><BOOL /></type></variable>
        </outputVars>
        <localVars>
            <variable name="fbOpenSimulated"><type><BOOL /></type></variable>
            <variable name="fbCloseSimulated"><type><BOOL /></type></variable>
            <variable name="selectedPosition"><type><REAL /></type></variable>
            <variable name="DelayTimer1"><type><derived name="TON" /></type></variable>
            <variable name="DelayTimer2"><type><derived name="TON" /></type></variable><!-- Temporary variables for MTP base interface access -->
            <variable name="StateChannel"><type><BOOL /></type></variable>
            <variable name="StateOpAct"><type><BOOL /></type></variable>
            <variable name="StateAutAct"><type><BOOL /></type></variable>
            <variable name="StateOffAct"><type><BOOL /></type></variable>
            <variable name="SrcChannel"><type><BOOL /></type></variable>
            <variable name="SrcManAut"><type><BOOL /></type></variable>
            <variable name="SrcIntAut"><type><BOOL /></type></variable>
            <variable name="SrcIntAct"><type><BOOL /></type></variable>
            <variable name="SrcManAct"><type><BOOL /></type></variable>
            <variable name="PermEn"><type><BOOL /></type></variable>
            <variable name="Permit"><type><BOOL /></type></variable>
            <variable name="IntlEn"><type><BOOL /></type></variable>
            <variable name="Interlock"><type><BOOL /></type></variable>
            <variable name="ProtEn"><type><BOOL /></type></variable>
            <variable name="Protect"><type><BOOL /></type></variable>
            <variable name="WQC"><type><BYTE /></type></variable>
            <variable name="OSLevel"><type><BYTE /></type></variable>
            <variable name="SafePos"><type><BOOL /></type></variable>
            <variable name="SafePosEn"><type><BOOL /></type></variable>
            <variable name="OpenAut"><type><BOOL /></type></variable>
            <variable name="CloseAut"><type><BOOL /></type></variable>
            <variable name="PosSclMin"><type><REAL /></type></variable>
            <variable name="PosSclMax"><type><REAL /></type></variable>
            <variable name="PosUnit"><type><INT /></type></variable>
            <variable name="PosMin"><type><REAL /></type></variable>
            <variable name="PosMax"><type><REAL /></type></variable>
            <variable name="PosInt"><type><REAL /></type></variable>
            <variable name="PosMan"><type><REAL /></type></variable>
            <variable name="Pos"><type><REAL /></type></variable>
            <variable name="OpenFbkCalc"><type><BOOL /></type></variable>
            <variable name="OpenFbk"><type><BOOL /></type></variable>
            <variable name="CloseFbkCalc"><type><BOOL /></type></variable>
            <variable name="CloseFbk"><type><BOOL /></type></variable>
            <variable name="PosFbkCalc"><type><BOOL /></type></variable>
            <variable name="PosFbk"><type><REAL /></type></variable>
            <variable name="ResetAut"><type><BOOL /></type></variable>
        </localVars>
    </interface>
    <body>
        <ST>
            <xhtml xmlns="http://www.w3.org/1999/xhtml">
                <![CDATA[
// Copy MTP base variables to local temporaries (READ access)
StateChannel := MTPBase.StateChannel;
StateOpAct := MTPBase.StateOpAct;
StateAutAct := MTPBase.StateAutAct;
StateOffAct := MTPBase.StateOffAct;
SrcChannel := MTPBase.SrcChannel;
SrcIntAct := MTPBase.SrcIntAct;
SrcManAct := MTPBase.SrcManAct;
OpenAut := MTPBase.OpenAut;
PosSclMin := MTPBase.PosSclMin;
PosSclMax := MTPBase.PosSclMax;
PosInt := MTPBase.PosInt;
PosMan := MTPBase.PosMan;
Pos := MTPBase.Pos;
OpenFbkCalc := MTPBase.OpenFbkCalc;
OpenFbk := MTPBase.OpenFbk;
CloseFbkCalc := MTPBase.CloseFbkCalc;
CloseFbk := MTPBase.CloseFbk;


WQC := 16#FF;
OSLevel := 16#00;
remote := StateChannel;
operator := StateOpAct;
automatic := StateAutAct;
offline := StateOffAct;
programSelectsSource := SrcChannel;
operatorSelectsSource := NOT SrcChannel;
internalSourceAct := SrcIntAct;
manualSourceAct := SrcManAct;
SrcManAut := activateManualSource;
SrcIntAut := activateDynamicSource OR activateFixedSource;
IF activateFixedSource THEN
    fixedSourceAct := TRUE;
END_IF;
IF activateDynamicSource THEN
    fixedSourceAct := FALSE;
END_IF;
dynamicSourceAct := NOT fixedSourceAct;
PermEn := True;
IntlEn := True;
ProtEn := True;
Permit := permitIn;
Interlock := NOT interlockIn;
Protect := NOT protectIn;
SafePos := safeOpen;
SafePosEn := enableSafePos;
selectedPosition := (PosInt * BOOL_TO_REAL(SrcIntAct)) + (PosMan * BOOL_TO_REAL(SrcManAct));
OpenAut := selectedPosition > 0;
CloseAut := NOT OpenAut;
OpenFbkCalc := simulate OR NOT hasFbOpen;
CloseFbkCalc := simulate OR NOT hasFbClose;
DelayTimer1(IN:= OpenFbkCalc AND OpenAut, PT:= REAL_TO_TIME(simulateDelay * 1000));
fbOpenSimulated := DelayTimer1.Q;
DelayTimer2(IN:= CloseFbkCalc AND NOT OpenAut, PT:= REAL_TO_TIME(simulateDelay * 1000));
fbCloseSimulated := DelayTimer2.Q;
OpenFbk := (feedbackOpen AND NOT OpenFbkCalc) OR (fbOpenSimulated AND OpenFbkCalc);
CloseFbk := (feedbackClose AND NOT CloseFbkCalc) OR (fbCloseSimulated AND CloseFbkCalc);
opened := OpenFbk;
closed := CloseFbk;
ResetAut := reset;
PosSclMin := scaleMin;
PosSclMax := scaleMax;
PosUnit := 0;
PosMin := PosSclMin;
PosMax := PosSclMax;
PosInt := (dynamicSource * BOOL_TO_REAL(dynamicSourceAct)) + (fixedSource * BOOL_TO_REAL(fixedSourceAct));
PosFbk := (positionOut * BOOL_TO_REAL(simulate)) + (feedbackPosition * BOOL_TO_REAL(simulate));
positionOut := Pos;
reset := False;

// Copy local temporaries back to MTP base variables (WRITE access)
MTPBase.SrcManAut := SrcManAut;
MTPBase.SrcIntAut := SrcIntAut;
MTPBase.PermEn := PermEn;
MTPBase.Permit := Permit;
MTPBase.IntlEn := IntlEn;
MTPBase.Interlock := Interlock;
MTPBase.ProtEn := ProtEn;
MTPBase.Protect := Protect;
MTPBase.WQC := WQC;
MTPBase.OSLevel := OSLevel;
MTPBase.SafePos := SafePos;
MTPBase.SafePosEn := SafePosEn;
MTPBase.OpenAut := OpenAut;
MTPBase.CloseAut := CloseAut;
MTPBase.PosSclMin := PosSclMin;
MTPBase.PosSclMax := PosSclMax;
MTPBase.PosUnit := PosUnit;
MTPBase.PosMin := PosMin;
MTPBase.PosMax := PosMax;
MTPBase.PosInt := PosInt;
MTPBase.OpenFbkCalc := OpenFbkCalc;
MTPBase.OpenFbk := OpenFbk;
MTPBase.CloseFbkCalc := CloseFbkCalc;
MTPBase.CloseFbk := CloseFbk;
MTPBase.PosFbkCalc := PosFbkCalc;
MTPBase.PosFbk := PosFbk;
MTPBase.ResetAut := ResetAut;
                ]]>
            </xhtml>
        </ST>
    </body>
</pou>